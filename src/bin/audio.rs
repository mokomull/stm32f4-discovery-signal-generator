#![no_main]
#![no_std]

use cortex_m::iprintln;
use cortex_m_rt::entry;
use panic_itm as _;

use stm32f4xx_hal::prelude::*;

// generated by: [int(0x700 * math.sin(2*math.pi/1000* t)) + 0x800 for t in range(0, 1000)]
static SINES: &[u16] = &[
    2048, 2059, 2070, 2081, 2093, 2104, 2115, 2126, 2138, 2149, 2160, 2171, 2182, 2194, 2205, 2216,
    2227, 2239, 2250, 2261, 2272, 2283, 2294, 2306, 2317, 2328, 2339, 2350, 2361, 2372, 2383, 2394,
    2405, 2416, 2427, 2438, 2449, 2460, 2471, 2482, 2493, 2504, 2515, 2526, 2537, 2547, 2558, 2569,
    2580, 2591, 2601, 2612, 2623, 2633, 2644, 2655, 2665, 2676, 2686, 2697, 2707, 2718, 2728, 2738,
    2749, 2759, 2770, 2780, 2790, 2800, 2810, 2821, 2831, 2841, 2851, 2861, 2871, 2881, 2891, 2901,
    2911, 2921, 2930, 2940, 2950, 2960, 2969, 2979, 2989, 2998, 3008, 3017, 3027, 3036, 3045, 3055,
    3064, 3073, 3083, 3092, 3101, 3110, 3119, 3128, 3137, 3146, 3155, 3164, 3172, 3181, 3190, 3198,
    3207, 3216, 3224, 3233, 3241, 3249, 3258, 3266, 3274, 3282, 3291, 3299, 3307, 3315, 3323, 3330,
    3338, 3346, 3354, 3361, 3369, 3377, 3384, 3392, 3399, 3406, 3414, 3421, 3428, 3435, 3443, 3450,
    3457, 3463, 3470, 3477, 3484, 3491, 3497, 3504, 3510, 3517, 3523, 3530, 3536, 3542, 3548, 3554,
    3561, 3567, 3572, 3578, 3584, 3590, 3596, 3601, 3607, 3612, 3618, 3623, 3629, 3634, 3639, 3644,
    3649, 3654, 3659, 3664, 3669, 3674, 3678, 3683, 3688, 3692, 3697, 3701, 3705, 3709, 3714, 3718,
    3722, 3726, 3730, 3734, 3737, 3741, 3745, 3748, 3752, 3755, 3759, 3762, 3765, 3768, 3771, 3774,
    3777, 3780, 3783, 3786, 3789, 3791, 3794, 3796, 3799, 3801, 3803, 3806, 3808, 3810, 3812, 3814,
    3816, 3817, 3819, 3821, 3822, 3824, 3825, 3827, 3828, 3829, 3830, 3832, 3833, 3834, 3834, 3835,
    3836, 3837, 3837, 3838, 3838, 3839, 3839, 3839, 3839, 3839, 3840, 3839, 3839, 3839, 3839, 3839,
    3838, 3838, 3837, 3837, 3836, 3835, 3834, 3834, 3833, 3832, 3830, 3829, 3828, 3827, 3825, 3824,
    3822, 3821, 3819, 3817, 3816, 3814, 3812, 3810, 3808, 3806, 3803, 3801, 3799, 3796, 3794, 3791,
    3789, 3786, 3783, 3780, 3777, 3774, 3771, 3768, 3765, 3762, 3759, 3755, 3752, 3748, 3745, 3741,
    3737, 3734, 3730, 3726, 3722, 3718, 3714, 3709, 3705, 3701, 3697, 3692, 3688, 3683, 3678, 3674,
    3669, 3664, 3659, 3654, 3649, 3644, 3639, 3634, 3629, 3623, 3618, 3612, 3607, 3601, 3596, 3590,
    3584, 3578, 3572, 3567, 3561, 3554, 3548, 3542, 3536, 3530, 3523, 3517, 3510, 3504, 3497, 3491,
    3484, 3477, 3470, 3463, 3457, 3450, 3443, 3435, 3428, 3421, 3414, 3406, 3399, 3392, 3384, 3377,
    3369, 3361, 3354, 3346, 3338, 3330, 3323, 3315, 3307, 3299, 3291, 3282, 3274, 3266, 3258, 3249,
    3241, 3233, 3224, 3216, 3207, 3198, 3190, 3181, 3172, 3164, 3155, 3146, 3137, 3128, 3119, 3110,
    3101, 3092, 3083, 3073, 3064, 3055, 3045, 3036, 3027, 3017, 3008, 2998, 2989, 2979, 2969, 2960,
    2950, 2940, 2930, 2921, 2911, 2901, 2891, 2881, 2871, 2861, 2851, 2841, 2831, 2821, 2810, 2800,
    2790, 2780, 2770, 2759, 2749, 2738, 2728, 2718, 2707, 2697, 2686, 2676, 2665, 2655, 2644, 2633,
    2623, 2612, 2601, 2591, 2580, 2569, 2558, 2547, 2537, 2526, 2515, 2504, 2493, 2482, 2471, 2460,
    2449, 2438, 2427, 2416, 2405, 2394, 2383, 2372, 2361, 2350, 2339, 2328, 2317, 2306, 2294, 2283,
    2272, 2261, 2250, 2239, 2227, 2216, 2205, 2194, 2182, 2171, 2160, 2149, 2138, 2126, 2115, 2104,
    2093, 2081, 2070, 2059, 2048, 2037, 2026, 2015, 2003, 1992, 1981, 1970, 1958, 1947, 1936, 1925,
    1914, 1902, 1891, 1880, 1869, 1857, 1846, 1835, 1824, 1813, 1802, 1790, 1779, 1768, 1757, 1746,
    1735, 1724, 1713, 1702, 1691, 1680, 1669, 1658, 1647, 1636, 1625, 1614, 1603, 1592, 1581, 1570,
    1559, 1549, 1538, 1527, 1516, 1505, 1495, 1484, 1473, 1463, 1452, 1441, 1431, 1420, 1410, 1399,
    1389, 1378, 1368, 1358, 1347, 1337, 1326, 1316, 1306, 1296, 1286, 1275, 1265, 1255, 1245, 1235,
    1225, 1215, 1205, 1195, 1185, 1175, 1166, 1156, 1146, 1136, 1127, 1117, 1107, 1098, 1088, 1079,
    1069, 1060, 1051, 1041, 1032, 1023, 1013, 1004, 995, 986, 977, 968, 959, 950, 941, 932, 924,
    915, 906, 898, 889, 880, 872, 863, 855, 847, 838, 830, 822, 814, 805, 797, 789, 781, 773, 766,
    758, 750, 742, 735, 727, 719, 712, 704, 697, 690, 682, 675, 668, 661, 653, 646, 639, 633, 626,
    619, 612, 605, 599, 592, 586, 579, 573, 566, 560, 554, 548, 542, 535, 529, 524, 518, 512, 506,
    500, 495, 489, 484, 478, 473, 467, 462, 457, 452, 447, 442, 437, 432, 427, 422, 418, 413, 408,
    404, 399, 395, 391, 387, 382, 378, 374, 370, 366, 362, 359, 355, 351, 348, 344, 341, 337, 334,
    331, 328, 325, 322, 319, 316, 313, 310, 307, 305, 302, 300, 297, 295, 293, 290, 288, 286, 284,
    282, 280, 279, 277, 275, 274, 272, 271, 269, 268, 267, 266, 264, 263, 262, 262, 261, 260, 259,
    259, 258, 258, 257, 257, 257, 257, 257, 256, 257, 257, 257, 257, 257, 258, 258, 259, 259, 260,
    261, 262, 262, 263, 264, 266, 267, 268, 269, 271, 272, 274, 275, 277, 279, 280, 282, 284, 286,
    288, 290, 293, 295, 297, 300, 302, 305, 307, 310, 313, 316, 319, 322, 325, 328, 331, 334, 337,
    341, 344, 348, 351, 355, 359, 362, 366, 370, 374, 378, 382, 387, 391, 395, 399, 404, 408, 413,
    418, 422, 427, 432, 437, 442, 447, 452, 457, 462, 467, 473, 478, 484, 489, 495, 500, 506, 512,
    518, 524, 529, 535, 542, 548, 554, 560, 566, 573, 579, 586, 592, 599, 605, 612, 619, 626, 633,
    639, 646, 653, 661, 668, 675, 682, 690, 697, 704, 712, 719, 727, 735, 742, 750, 758, 766, 773,
    781, 789, 797, 805, 814, 822, 830, 838, 847, 855, 863, 872, 880, 889, 898, 906, 915, 924, 932,
    941, 950, 959, 968, 977, 986, 995, 1004, 1013, 1023, 1032, 1041, 1051, 1060, 1069, 1079, 1088,
    1098, 1107, 1117, 1127, 1136, 1146, 1156, 1166, 1175, 1185, 1195, 1205, 1215, 1225, 1235, 1245,
    1255, 1265, 1275, 1286, 1296, 1306, 1316, 1326, 1337, 1347, 1358, 1368, 1378, 1389, 1399, 1410,
    1420, 1431, 1441, 1452, 1463, 1473, 1484, 1495, 1505, 1516, 1527, 1538, 1549, 1559, 1570, 1581,
    1592, 1603, 1614, 1625, 1636, 1647, 1658, 1669, 1680, 1691, 1702, 1713, 1724, 1735, 1746, 1757,
    1768, 1779, 1790, 1802, 1813, 1824, 1835, 1846, 1857, 1869, 1880, 1891, 1902, 1914, 1925, 1936,
    1947, 1958, 1970, 1981, 1992, 2003, 2015, 2026, 2037,
];

#[entry]
fn main() -> ! {
    let peripherals = stm32f407g_disc::Peripherals::take().unwrap();
    let mut core_peripherals = cortex_m::Peripherals::take().unwrap();

    let rcc = peripherals.RCC.constrain();
    let clocks = rcc.cfgr.use_hse(8.mhz()).sysclk(168.mhz()).freeze();

    let itm = &mut core_peripherals.ITM.stim[0];

    let porta = peripherals.GPIOA.split();

    // the DAC overrides what was selected in the GPIO module, but the datasheet recommended the pin
    // be switched to analog input.
    let _signal_out = porta.pa4.into_analog();

    // enable the DAC peripheral
    unsafe {
        let rcc = &*stm32f4xx_hal::stm32::RCC::ptr();
        rcc.apb1enr.modify(|_r, w| {
            w.dacen().set_bit();
            w.tim3en().set_bit()
        });
    }
    let dac = peripherals.DAC;
    let timer = peripherals.TIM3;
    // 84MHz (since I suppose the APBx prescaler causes the timer clock to be doubled) / 1Msps
    timer.arr.write(|w| w.arr().bits(84));
    timer.cr1.write(|w| w.cen().set_bit());

    dac.cr.write(|w| w.en1().set_bit());

    loop {
        for &value in SINES {
            while !timer.sr.read().uif().bit() {}
            timer.sr.modify(|_r, w| w.uif().clear_bit());

            dac.dhr12r1.write(|w| unsafe { w.dacc1dhr().bits(value) });
        }
    }
}
